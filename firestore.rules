rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    match /users/{userId}/{document=**} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    match /sharedLists/{listId} {
      // Allow CREATION by any signed-in user, but only if they set themselves as creator and member.
      allow create: if isSignedIn()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.auth.uid in request.resource.data.members;

      // Allow READ access to members of the list.
      allow read: if isSignedIn() && resource.data.members.hasAny([request.auth.uid]);

      // Allow UPDATES under two conditions:
      // 1. The user is already a member (for regular article updates).
      // 2. The user is joining for the first time.
      allow update: if isSignedIn() && 
                    ( (resource.data.members.hasAny([request.auth.uid])) || 
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']) && 
                       request.resource.data.members == resource.data.members.concat([request.auth.uid]))
                    );

      // Optional: Allow the creator to delete the list.
      allow delete: if isSignedIn() && request.auth.uid == resource.data.createdBy;
    }
  }
}
